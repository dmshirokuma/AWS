# EC2

## EC2概要

AWSが提供するIaaS（仮想マシン）

## 構成サービス

- EC2インスタンス（仮想マシン本体）
- EBS（ストレージ）
- ELB（ロードバランサー）
- ASG（自動スケーリング）
- ネットワーク系
  - Security Group

## インスタンスタイプ

一覧は以下を参照

https://instances.vantage.sh/

- General Purpose（M,T,Aタイプ）
  - 汎用的なタイプ。CPU、メモリ、ネットワークのバランスが取れている。
  - 用途
    - WebServer
    - コードリポジトリ
- Copute Optimized（Cタイプ）
  - 処理能力特化のタイプ。
  - 用途
    - バッチ処理
    - メディアのトランスコード
    - 高性能のWebServer
    - 機械学習
    - ゲームサーバー
- Memory Optimized（R,X,High Memory, Zタイプ）
  - メモリ最適化タイプ
  - 用途
    - RDBやInMemoryDBの高性能化
    - キャッシュストア
    - ビッグデータのリアルタイム処理
- Storage Optimized（I,G,Hタイプ）
  - ストレージ最適化タイプ
  - 用途
    - 高頻度のオンライントランザクション（OLTP）
    - RDB
    - NoSQL
    - RedisなどのCache for in-memory database
    - データウェアハウス
    - 分散ファイルシステム

## Security Group　概要

EC2インスタンスのファイアウォールとして機能し、トラフィックの出入りを制御する

- インバウンド、アウトバウンドそれぞれで設定可能
- ポート制御可能
- 1セキュリティグループを複数EC2インスタンスにアタッチすることが可能
- リージョン/VPC内にセキュリティグループを作成するため、リージョンやVPCをまたいでセキュリティグループは適用できない
- セキュリティグループから他のセキュリティグループを参照できる
  - 例えばセキュリティグループ作成時にセキュリティグループ１からのインバウンドを許可するようにすることが可能であり  
  その場合はセキュリティグループ１がアタッチされているEC2インスタンスからのアクセスを許可できる

## SSHでの接続

ターミナルからダウンロードしたkeypairを使用して接続する

```shell
ssh -i [keypair] ec2-user@[EC2のIPアドレス]
```

keypairに対してpermissonのエラーが発生することがあるが、keypairに対するpermissonが大きすぎるとエラーとなるようになっている。
以下のコマンドでpermissionを絞って接続する。

```shell
chmod 400 [keypair]
```

接続タイムタウトが発生する場合はセキュリティーグループの設定を見直す

その他の接続方法としてAWSコンソールからEC2InstanceConnectを使用する方法がある。   
コンソール（ブラウザ）から直接接続するため、keypairを管理する必要がなくなる。  
ただし、EC2InstanceConnectもssh接続を行うため、セキュリティグループでポート22は開けておく必要がある。

## ベストプラクティス

ターミナル内から他のAWSサービス（例えばIAMなど）にアクセスする場合、以下を実行してくださいというアラートが表示される。

```shell
$ aws iam list-users
Unable to locate credentials. You can configure credentials by running "aws configure".
```

この通りに設定し、続いてAccess Keyなどの情報を入力してはいけない。  
IAMから操作に対する権限を付与したRole(この場合は「IAMReadOnlyAccess」を付与したRole)を作成し  
EC2インスタンスにアタッチするのが正解。


## EC2の購入タイプについて

- OnDemand（オンデマンド）
  - 使用したいときに必要なだけ使用するタイプ
  - 短時間で中断のない稼働やアプリケーションの動作が予測不能な場合に推奨
- Reserved（リザーブドインスタンス）
  - 使用する期間があらかじめ決まっている際に使用するタイプ
  - Reserved
    - OnDemandと比較して72%の割引となる
    - いくつかの属性が固定される（インスタンスタイプ、リージョン、テナント、OS）
    - １年や３年契約にするとさらに割引
    - 前払いや一部前払いといった方法も可能
  - Convertible Reserved
    - インスタンスタイプ、インスタンスファミリー、OS、スコープ、テナントを変更でき  
    Reservedよりは柔軟で最大66%割引
- Saving Plan（節約プラン）
  - 月々でどれだけ使用するかをあらかじめ決めて予約しておくタイプ
    - 予約した量を超えて使用した場合は、そこからOnDemandによる課金となる
  - 最大72%割引となる
  - 長期的な利用に基づいて割引を受けられる
  - 特定のインスタンスファミリーやリージョンに固定となる
- Spot（スポットインスタンス）
  - 処理能力の高いインスタンスを入札で買う
    - ただし別に入札した額より高い金額を払う人がいれば停止させられる可能性がある
  - 現在価格が自身の価格を上回ったときには２分以内にインスタンス停止 or 終了させる必要がある
  - １時間〜６時間は中断なしでインスタンスを維持することも可能だが保証されるわけではない(Spot Block)
  - 最大90%割引
  - 用途
    - バッチジョブ
    - データ分析
    - 画像処理などの分散ワークロード
    - 開始時間と終了時間が柔軟なワークロードなどに使用する
  - クリティカルなジョブやデータベースに使用しないこと
- Dedicated Hosts（専用ホスト）
  - 専用のサーバー上にインスタンスを構築する
  - インスタンスの配置場所を変更することが可能
  - 用途
    - 規制やコンプライアンスを強く必要とする要件がある場合
    - 既存のサーバー向けソフトウェアライセンスを使用する場合（複数台で使用してはいけないライセンスなど）
    - 支払い方法
      - OnDemand
      - Reserved(1年 or 3年契約)
- Dedicated Instances（専用インスタンス）
  - 自分のハードウェア上で稼働するインスタンス
  - インスタンスの配置場所を変更することはできない

## Spot（スポットインスタンス）について

スポットインスタンスでは以下を定義し、スポットリクエストを送信する必要がある。

- 欲しいインスタンスの数
- 支払う予定の最大価格
- ローンチの仕様（AMIの定義）
- リクエストの有効期限

スポットリクエストは1回のみ、永続的のどちらでも可能。

永続的リクエストの場合
スポット価格に基づいてインスタンスが停止したり中断した場合、再度スポットリクエストが送信される。

スポットインスタンスを永続的に終了させたい場合は以下の手順を踏む必要がある。

1. スポットリクエストのキャンセル
2. 関連するスポットインスタンスの終了（AWSが勝手に終了させてはくれない）

先にスポットインスタンスを終了させてしまうと再度スポットリクエストが送信されてしまうので  
先にスポットリクエストをキャンセルする必要がある。

## Spot Fleet

スポットインスタンスとオンデマンドインスタンス（オプション）のセット  
以下を設定しておくことによってその中で一番安いスポットインスタンスを自動で複数起動できる。

- 最高価格
- 複数のインスタンスタイプ
- Availability Zone

## Elastic IP概要

EC2インスタンスは停止、起動を行うたびにPublic IPが変化する。  
停止、起動を行った場合でも同じPublic IPを使用したい場合は  
Elastic IPをEC2インスタンスに対して関連づける必要がある。

### 操作

1. Elastic IPを選択し、「Elastic IPを割り当てる」を選択
2. 情報を入力し、「割り当て」を選択
3. 取得したElastic IPを選択しアクションから「Elastic IPアドレスの関連付け」を選択
4. 関連づけたいEC2インスタンスを選択（※）

※ Elastic IPはEC2インスタンスのみではなく、ネットワークインターフェースに関連づけることも可能。  
関連付けを行っていない状態でElastic IPを取得した状態が続くと料金がかかるため  
Elastic IP取得後はなるべく早めに関連付けを行うこと。

## プレイスメントグループ

プレイスメントグループではEC2インスタンスをAWS内のどこに配置していくかを決定する。
プレイスメントグループでは以下の３つの戦略をとることが可能。

- Cluster
  - 単一アベイラビリティゾーンの単一ラックに複数EC2を配置する
    - グループに対して障害が発生すると全てが停止するため、リスクは高い
  - 用途
    - 低ネットワークレイテンシー、高スループットを必要とするアプリケーション
    - 高速で完了させる必要があるBigDataジョブ
- Spread
  - 複数アベイラビリティゾーンの完全に別のハードウェアにEC2インスタンスに配置する  
　　（1アベイラビリティゾーンに最大7インスタンスまで配置可能）
    - それぞれがハードウェアを共有しない
  - 用途
    - クリティカルなアプリケーション
- Partition
  - 複数アベイラビリティゾーンにパーティションを構成し、それぞれにEC2インスタンスを配置する
    - 1アベイラビリティゾーンに7つまでのパーティションを持つことが可能
    - それぞれのパーティションでラックを共有しないため、単一ラックのハードウェア障害は他ラックに影響しない
    - 1パーティションにEC2インスタンスを100台までスケールさせることができる
  - 用途
    - Hadoop
    - Cassandra
    - Kafka

### 操作

1. EC2のコンソールから「Network & Security」内にある「プレイスメントグループ」を選択
2. 「プレイスメントグループを作成」を選択
3. 名前とプレイスメント戦略を選択して作成
4. EC2の「インスタンスを起動」から「高度な詳細」を選択
5. 「高度な詳細」から作成した「プレイスメントグループ」を選択

## Elastic Network Interface概要

仮想ネットワークカードであり、対象のAWSサービス（EC2など）にインターネットアクセスを提供する。

- 1つのプライマリPrivate IPを保持する
- 1つ以上のセカンダリPrivate IPを保持することが可能
- 1つのPrivate IPごとに1つのElastic IPを保持することが可能
- 1つのPublic IPを保持する
- 1つ以上のセキュリティグループをアタッチすることが可能
- MACアドレスを付与することが可能
- 独立して作成可能、ENIを別のEC2インスタンスに付与するなどでフェイルオーバーさせるといった使い方が可能
- アベイラビリティゾーンを超えてアタッチすることはできない

### 操作

1. EC2のコンソールから「Network & Security」内にある「ネットワークインターフェース」を選択
2. 「ネットワークインターフェースの作成」を選択
3. 情報を入力して「ネットワークインターフェイスの作成」
4. アクションから「アタッチ」を使用してEC2にアタッチする

###　フェイルオーバーさせる

1. アクションから「デタッチ」を使用してEC2からENIをデタッチする
2. 別のEC2にデタッチしたENIをアタッチする

これによってPrivate IPでアクセスしていたアプリの向き先を別のEC2に向けることができる。

### ENIが関連づけられたEC2を削除した場合の挙動

ENIが関連づけられたEC2を削除した場合はEC2と同時に作成されたENIは同時に削除される。  
つまりEC2と同時に作成されたENIには終了時に削除するフラグが付与されている。  
単独で作成したENIは削除されずにそのまま残る。

## EC2 ハイバネーション

通常EC2が停止するとOSも停止となるため、メモリ上にあったデータは消失する。  
しかしEC2 ハイバネーションを使用することによってメモリ上のデータ消失を防ぎつつ、EC2を停止することができる。
具体的には以下のようになる。

1. EC2停止処理開始
2. EC2のメモリ上にあったデータをEBSに待避
3. EC2の停止完了

起動時

1. EC2起動処理開始
2. EBS上のデータをEC2から読み込み
3. 停止前の状態でEC2起動

### 用途

- 長時間実行されるプロセスが必要な場合
- メモリの状態を保存しておきたい場合
- EC2の高速起動や再起動を行いたい場合（アプリケーション初期化に時間がかかる等）

### 操作

EC2インスタンス起動時のメニューから以下の操作を行う。

1. ストレージから「アドバンスト」を選択し、ルートボリュームの「暗号化済み」にて「暗号化済み」を選択（※）
2. KMSキーにてデフォルトの「aws/ebs」を選択
3. 「高度な詳細」から「停止 - 休止動作」から「有効化」を選択する

※ EC2ハイバネーションを行う場合はEC2の終了時にRAMの内容がルートEBSに書き込まれるため  
ルートEBSは暗号化されてい必要がある。

