# RDS

## 概要

- AWS上にSQLで操作可能なリレーショナルデータベースを作成できるサービス
  - Postgres
  - MySQL
  - MariaDB
  - Oracle
  - Microsoft SQL Server
  - IBM DB2
  - Aurora(AWS独自のデータベース)
- AWSによって管理される
  - データベースの作成は完全に自動化（基礎となるOSのパッチ適用も自動）
  - 継続的にバックアップが自動で取得される
    - 特定のタイムスタンプにリストアすることが可能
  - ダッシュボードでパフォーマンスを見ることも可能
  - リードレプリカを持つことが可能
  - マルチAZに対応している
  - アップグレード用にメンテナンス期間がある
  - スケーリング機能あり
    - スケールアップ
    - スケールアウト
  - ストレージはEBS(gp2 or io1)
  - SSHで接続はできない

## Storage Auto Scaling

自動でストレージのスケーリングを行ってくれる。

- データベースを停止する必要なく、動的にスケーリングしてくれる
- ストレージの最大値を設定する必要がある
- 例えば以下のような場合に自動スケーリングさせる
  - 残ストレージ容量が10%を下回った場合
  - ストレージ不足が5分以上続いている
  - 最後のスケーリングから6時間経過した
- 全てのRDSエンジンで可能

## リードレプリカの特徴

- 最大15までのリードレプリカを拡張可能
- 異なるAZや異なるリージョンに配置することも可能
- メインとなるRDSインスタンスとリードレプリカ間は非同期によるレプリケーションとなる
  - 最終的には一貫性が保たれる
  - 非同期のため、リードレプリカからは更新前のデータが取得される可能性がある
- リードレプリカはメインのRDSインスタンスへと昇格させることが可能
  - この場合はアプリケーション側のDB接続情報を更新する必要がある
- 名前の通り、READのみが可能INSET,UPDATE,DELETEは不可

## リードレプリカのユースケース

- 本番で動いているRDSに対して別の目的（レポートを作成したいなど）で負荷の高い読み込みが発生する場合
  - リードレプリカを作成してレプリカからレポート作成を行ってもらう

## ネットワークコスト

- AWSでは基本的には別AZへのデータ転送には料金がかかるが、RDSのようなマネージドサービスについては別AZへの料金は発生しない
  - 別AZにあるリードレプリカにレプリケーションされても料金は発生しない
- マネージドサービスであっても別リージョンへのデータ転送には料金が発生する
  - にRDSのリードレプリカを別リージョンに作成した場合は別リージョンへのレプリケーションが料金が発生する

## マルチAZについて

マルチAZは主に災害対策として行われる

- マスターのRDSインスタンスとスタンバイなリードレプリカを別AZに配置しておく
- マスターのRDSインスタンスに障害が発生した場合はスタンバイなリードレプリカに自動でフェールオーバーする
  - この場合リードレプリカはマスターに昇格する
  - 手動操作は必要なし
- スケールには適用されない

## シングルAZからマルチAZへの移行について

- ダウンタイム無しで移行可能
- データベースの変更でマルチAZとするだけでOK
- シングルAZからマルチAZに移行した場合、内部的には以下となる
  - マスターRDSのスナップショットが取得される
  - スナップショットを用いて新AZにリストアされる
  - スタンバイなデータベースが復元されるとマスターRDSとの同期が開始される