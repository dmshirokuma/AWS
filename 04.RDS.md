# RDS

## 概要

- AWS上にSQLで操作可能なリレーショナルデータベースを作成できるサービス
  - Postgres
  - MySQL
  - MariaDB
  - Oracle
  - Microsoft SQL Server
  - IBM DB2
  - Aurora(AWS独自のデータベース)
- AWSによって管理される
  - データベースの作成は完全に自動化（基礎となるOSのパッチ適用も自動）
  - 継続的にバックアップが自動で取得される
    - 特定のタイムスタンプにリストアすることが可能
  - ダッシュボードでパフォーマンスを見ることも可能
  - リードレプリカを持つことが可能
  - マルチAZに対応している
  - アップグレード用にメンテナンス期間がある
  - スケーリング機能あり
    - スケールアップ
    - スケールアウト
  - ストレージはEBS(gp2 or io1)
  - SSHで接続はできない

## Storage Auto Scaling

自動でストレージのスケーリングを行ってくれる。

- データベースを停止する必要なく、動的にスケーリングしてくれる
- ストレージの最大値を設定する必要がある
- 例えば以下のような場合に自動スケーリングさせる
  - 残ストレージ容量が10%を下回った場合
  - ストレージ不足が5分以上続いている
  - 最後のスケーリングから6時間経過した
- 全てのRDSエンジンで可能

## リードレプリカの特徴

- 最大15までのリードレプリカを拡張可能
- 異なるAZや異なるリージョンに配置することも可能
- メインとなるRDSインスタンスとリードレプリカ間は非同期によるレプリケーションとなる
  - 最終的には一貫性が保たれる
  - 非同期のため、リードレプリカからは更新前のデータが取得される可能性がある
- リードレプリカはメインのRDSインスタンスへと昇格させることが可能
  - この場合はアプリケーション側のDB接続情報を更新する必要がある
- 名前の通り、READのみが可能INSET,UPDATE,DELETEは不可

## リードレプリカのユースケース

- 本番で動いているRDSに対して別の目的（レポートを作成したいなど）で負荷の高い読み込みが発生する場合
  - リードレプリカを作成してレプリカからレポート作成を行ってもらう

## ネットワークコスト

- AWSでは基本的には別AZへのデータ転送には料金がかかるが、RDSのようなマネージドサービスについては別AZへの料金は発生しない
  - 別AZにあるリードレプリカにレプリケーションされても料金は発生しない
- マネージドサービスであっても別リージョンへのデータ転送には料金が発生する
  - にRDSのリードレプリカを別リージョンに作成した場合は別リージョンへのレプリケーションが料金が発生する

## マルチAZについて

マルチAZは主に災害対策として行われる

- マスターのRDSインスタンスとスタンバイなリードレプリカを別AZに配置しておく
- マスターのRDSインスタンスに障害が発生した場合はスタンバイなリードレプリカに自動でフェールオーバーする
  - この場合リードレプリカはマスターに昇格する
  - 手動操作は必要なし
- スケールには適用されない

## シングルAZからマルチAZへの移行について

- ダウンタイム無しで移行可能
- データベースの変更でマルチAZとするだけでOK
- シングルAZからマルチAZに移行した場合、内部的には以下となる
  - マスターRDSのスナップショットが取得される
  - スナップショットを用いて新AZにリストアされる
  - スタンバイなデータベースが復元されるとマスターRDSとの同期が開始される

## RDS カスタム

RDSでは通常、基盤となるOSに対してアクセスすることはできない。
ただし「Oracle」および「Microsoft SQL Server」に対しては「RDS カスタム」を使用することにより、OSへアクセスすることが可能。
これによって以下が可能となる。

- 内部構成の設定変更
- パッチインストール
- ネイティブ機能の有効化
- SSHやSSG Session Managerを使用した基盤部分のEC2へのアクセス

ただし、OSへアクセス可能となる=DBを壊す可能性がある
ということなので事前にスナップショットの取得が必須。

## Amazon Aurora

- AWSによって作成されたデータベース
- 以下のDBと互換性がある（既存の接続ツールやドライバなどをそのまま使用可能）
  - MySQL
  - PostgreSQL
- AWSクラウドに最適化されているため、5倍程度のパフォーマンスが見込める
- RDS上のMySQLやPostfreSQLの3倍程度のパフォーマンスが見込める
- ストレージは自動拡張される（10GB-128TB）
- 最大15までのリードレプリカを持つことが可能
  - レプリカの遅延は10ms程度となる
  - どのリードレプリカもマスターに昇格することが可能
  - 自動スケーリングを設定することが可能（常に適切な数のリードレプリカを保持することが可能）
- RDS上のMySQLと比べてフェイルオーバーが高速（デフォルトで高可用性が得られる）
- 他のRDSと比較して約20%ほど高額
- データボリュームは3AZに2つずつ（計6つ配置される）
  - 書き込み
    - 6ボリュームのうち、4つだけ必要（つまり1AZがダウンしても問題無し）
  - 読み込み
    - 6ボリュームのうち、3つだけ必要
- 自己修復機能有り
- 6つのインスタンスのうち、書き込みを受け取るインスタンスはマスターの１つのみ（Writer Endpoint）
  - マスターが機能しなくなった場合、自動でフェイルオーバーする（平均30秒以内）
- リージョン間でのレプリケーションをサポート

## Aurora DB Cluster

- 共有ストレージボリュームがあり、10G-128TBに自動拡張される
- 書き込み
  - 1つの「Writer Endpoint」に対して書き込みを行う
    - 「Writer Endpoint」は1つのマスターに割り当てられる
- 読み込み
  - 1つの「Reader Endpoint」に対して読み込みを行う
    - 「Reader Endpoint」は全リードレプリカに対して自動的にロードバランスされる

## Aurora Custom Endpoints

Auroraのサブセットである一部インスタンスに対してエンドポイントを設定することができる。
例えば以下のようなイメージ。

### 通常構成

- Writer Endpoint
  - Instance1
- Reader Endpoint
  - Instance2(db.r3.large)
  - Instance3(db.r3.large)
  - Instance4(db.r5.2xlarge)
  - Instance5(db.r5.2xlarge)

上記の場合、Instance4, Instance5は他のリードレプリカと比べて処理能力が高い。
このような場合にInstance4, Insrance5のみに接続されるカスタムエンドポイントを設定することができる。
（Instance4, Instance5のように処理能力の高いインスタンスのみで分析クエリを実行したりできる。）
カスタムエンドポイントを設定した場合は、通常のReader Endpointから接続されなくなる。
つまり、全てのインスタンスがいずれかのカスタムエンドポイントに含まれる状態にする必要がある。

### カスタムエンドポイント構成後

- Writer Endpoint
  - Instance1
- Custom Endpoint1
  - Instance2(db.r3.large)
  - Instance3(db.r3.large)
- Custom Endpoint2
  - Instance4(db.r5.2xlarge)
  - Instance5(db.r5.2xlarge)

## Aurora Serverless

自動化されたデータベースが提供される。
実際の使用状況に基づいたインスタンス化と自動スケーリングが行われる。
以下のような場合に使用する。

- 接続頻度は少ないが、断続的に使用する場合
- 予測不能なワークロード
  - 事前プロビジョニングが不要

秒単位での支払いとなり、コスト効率が良くなることが期待できる。

## Global Aurora

- クロスリージョンでのリードレプリカ構築
  - 災害時復旧
  - プライマリリージョン（読み書き用）を１つ決める
  - 最大5つまでの読み取り専用リージョンを設定可能
    - 世界中でレプリケートは1秒未満
    - リージョンあたり最大16個のリードレプリカを設定可能
    - リージョンあたりで1分以内に復旧

## Aurora Machine Learning

Auroraと他のAWS機械学習サービスをSQLを通して利用することが可能

例えば以下のような流れで実行される。
最終的にアプリケーションは予測結果をSQLの戻り値として取得することが可能。

Application→(SQL)→Aurora→Amazon SaveMaker, Amazon Comprehend

- 統合されている機械学習サービス
  - Amazon SageMaker
  - Amazon Comprehend
- use case
  - 不正行為の検出
  - ADSターゲットの検出
  - 感情分析
  - レコメンドエンジン

## RDS Backups(Aurora以外)

RDSのバックアップは以下の通り。

- 自動バックアップ
  - 毎日自動的にフルバックアップを取得する
  - さらに5分ごとにトランザクションログのバックアップが取得される
    - つまり最も早い復元ポイントは5分前となる
  - 自動バックアップの保持期間は1日-35日
  - 自動バックアップの保持期間を0とすると自動バックアップを無効にできる
- 手動バックアップ
  - ユーザー操作によってバックアップが取得される
  - 自動バックアップと異なり、ユーザーがどれだけの期間バックアップを保持するかを決めることができる
  - コストを節約するために手動バックアップを選択することが可能
    - 例えば月に2時間しか使用しないとわかっている場合、データベースを停止してもストレージ容量は課金され続けるが、手動バックアップを取得し、元のデータベースを削除することによって課金を停止させることが可能（スナップショットはRDSデータベースの実際のストレージよりもはるかに少ないコストで保持することが可能） 

## Aurora Backups

- 自動バックアップ
  - 自動バックアップの保持期間は1日-35日
  - 他のRDSとは異なり、自動バックアップを無効にすることはできない
  - バックアップ保持期間の範囲内であれば、どの時間でもリカバリさせることが可能
- 手動バックアップ
  - ユーザー操作によってバックアップが取得される
  - 自動バックアップと異なり、ユーザーがどれだけの期間バックアップを保持するかを決めることができる

## RDS & Aurora Restore

リストアではDBの巻き戻しではなく、常に新しいDBが作成される。

### S3 からのMySQL databaseの復元

- オンプレミスのデータをS3に配置し、S3からMySQL databaseを復元させることが可能
  - MySQL RDSだけではなく、MySQL Aurora clusterにも復元させることが可能
    - MySQL Auroraを使用したい場合はバックアップをPercona XtraBackupを使用してバックアップを取得する必要がある

## Aurora Database Cloning

既存のAurora DB Clusterのクローンを作成する。  
本番環境のAuroraからステージングのAuroraを作成したい場合などに使用する。
以下の特徴がある。

- スナップショット取得→リストアの流れよりも高速
  - 同じボリュームを使用するため、データコピーの処理が不要→高速
  - データの変更があるたびに追加ストレージが割り当てられ、対象データがコピーされて使用される（ベースとなるデータは共有される）

## RDS & Aurora Security

- データの暗号化
  - DB自体の暗号化
    - AMS KMSを使用して暗号化されたマスターが必要
      - マスターが暗号化されていない場合はレプリカも暗号化できない
      - 暗号化したい場合はスナップショットを取得し、再作成する場合に暗号化して復元する必要がある
    - 起動時に暗号化が実施される
  - クライアント-DB間の通信暗号化
    - デフォルトでTLSによる暗号化が行われる
    - クライアントではAWSの提供するTLSルート証明書を使用して通信する必要がある
- 認証
  - 基本的にはIAMロールを使用して認証する（EC2インスタンスにIAMロールを割り当てるなど）
    - 古典的なユーザー名とパスワードで認証することもできる
- セキュリティグループ
  - RDSにセキュリティグループを付与することも可能
- No SSH
  - RDS Customを除いてSSHで接続することはできない
- 監査ログ
  - どのようなクエリが実施されているかについてはCloudWatchに出力させることが可能

## Amazon RDS　Proxy

- フルマネージドのRDS用プロキシ
- プロキシ内でDBへのコネクションをプールする
  - 接続数を最適化できるため、DBへの接続効率(CPU, RAM)が良くなる
- サーバレスであり自動スケールする
- マルチAZ可能
- 全てのRDSおよびAuroraについてフェイルオーバーさせることが可能(フェイルオーバー時間は66%短縮化)
- クライアント（アプリケーションやLambda）はProxyに接続するだけなのでコードの変更が不用
- IAMを使用した認証が必須(AWS Secret Manager)
  - これによりその他の方法（publicなど）でRDSに接続することはできなくなる
